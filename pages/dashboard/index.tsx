import React, { useState, useEffect } from "react";
import { useContract, useDirectListings } from "@thirdweb-dev/react";
import MintButton from "@/components/MintButton";
import {
  MUMBAI_DIGITIZE_ETH_ADDRESS,
  MUMBAI_MARKETPLACE_ADDRESS,
} from "@/constant/addresses";
import { PackNFTCard } from "@/components/PackNFT";
import { useAddress } from "@thirdweb-dev/react";
import Head from "next/head";
import Navbar from "@/components/Navbar";
import { useLocalStorage } from "usehooks-ts";
import { User } from "@prisma/client";
import { USER_LOCAL_STORAGE_KEY } from "@/config";
import Loading from "@/components/Loading";

export default function index() {
  const { contract: marketplace } = useContract(
    MUMBAI_MARKETPLACE_ADDRESS,
    "marketplace-v3"
  );

  const { data: directListings } =
    useDirectListings(marketplace, {
      tokenContract: MUMBAI_DIGITIZE_ETH_ADDRESS,
    });

  const address = useAddress();
  const [user, setUser] = useLocalStorage<User | null>(
    USER_LOCAL_STORAGE_KEY,
    null
  );

  return (
    <div>
      <Head>
        <title>Dashboard | Digitize.eth</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Navbar />

      <div
        className="container"
        style={{
          marginTop: 100,
        }}
      >
        <h1 style={{ fontSize: 30, fontWeight: "bold", marginLeft: 20 }}>
          Welcome Back,{" "}
          {address
            ? `${address.substring(0, 6)}...${address.substring(
                address.length - 5,
                address.length - 1
              )}`
            : "Not signed in"}
          !
        </h1>
        <div
          className="row"
          style={{
            borderBottom: "1px solid grey",
            padding: 20,
          }}
        >
          <div>
            {address ? (
              <div
                style={{
                  backgroundColor: "#111111",
                  padding: 20,
                  borderRadius: 12,
                }}
              >
                {address.substring(0, 6).concat("...")}
                {address.substring(address.length - 5, address.length - 1)}
              </div>
            ) : (
              "Not signed in"
            )}
          </div>
        </div>
        <div
          className="row"
          style={{
            padding: 20,
          }}
        >
          <div
            style={{
              display: "flex",
              flexDirection: "row",
              alignItems: "center",
            }}
          >
            <h4>Your Items</h4>
            <MintButton />
          </div>
          <div>
            <div>
              {!!directListings ? (
                directListings?.map((listing, index) => (
                  <div className="card" key={index}>
                    <PackNFTCard
                      contractAddress={listing.assetContractAddress}
                      tokenId={listing.tokenId}
                      status={listing.status.toString()}
                      hideBtn={true}
                    />
                  </div>
                ))
              ) : (
                <Loading />
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
